<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Organograma Organizacional</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- Pan & Zoom (Timmy Willison) -->
<script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@9.4.0/dist/panzoom.min.js"></script>
<style>
:root{
  --bg:#f4f7fb; --card:#ffffff; --leader-bar:#0b62d6; --accent:#0b62d6;
  --muted:#6b7280; --line:#d3dae6; --shadow:0 4px 10px rgba(10,30,60,0.08);
  --radius:10px; --font-sans:"Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
html,body{height:100%;margin:0;font-family:var(--font-sans);background:var(--bg);color:#0b1724}
.container{height:100vh;display:flex;flex-direction:column;}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 20px;background:#fff;border-bottom:1px solid var(--line);box-shadow:var(--shadow);flex-wrap:wrap}
.title h1{font-size:20px;margin:0;color:var(--accent)}
.subtitle{color:var(--muted);font-size:13px;margin:0}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.controls button, .controls input[type="search"]{
  background:var(--card);border:1px solid var(--line);padding:6px 10px;border-radius:6px;box-shadow:var(--shadow);
  font-size:13px;color:#0b1724;transition:all .2s ease;
}
.controls input[type="search"]{padding-left:30px;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill="gray" width="16" height="16" viewBox="0 0 24 24"><path d="M21 20l-5.6-5.6A7.8 7.8 0 0 0 17 9a8 8 0 1 0-8 8 7.8 7.8 0 0 0 5.4-1.6L20 21z"/></svg>');background-repeat:no-repeat;background-position:8px center;}
.controls button:hover{transform:translateY(-2px);cursor:pointer;background:#f0f4fa}
.controls .primary{background:linear-gradient(180deg,var(--accent),#084bb0);color:white;border:none}
.controls .primary:hover{background:linear-gradient(180deg,#084bb0,#052c73)}
#backBtn{background:#fbe9e9;color:#9b1c1c;border:1px solid #e7c3c3;}
#backBtn:hover{background:#f8d6d6;}

/* Área pan/zoom */
.org-wrap{flex:1;overflow:hidden;position:relative;background:#f8fafc;border-top:1px solid var(--line)}
#panzoom{
  display:inline-block;
  transform-origin:0 0;
  touch-action:none;     /* necessário p/ pan/zoom por gesto */
  will-change:transform; /* performance */
}
.tree{display:flex;gap:30px;flex-wrap:wrap;justify-content:center;padding:40px;position:relative;}

/* Linhas hierárquicas */
.tree ul{display:flex;flex-wrap:wrap;gap:30px;justify-content:center;padding-top:30px;position:relative;}
.tree li{list-style:none;text-align:center;position:relative;display:flex;flex-direction:column;align-items:center;padding:10px 5px 0 5px;vertical-align:top;}
.tree li::before, .tree li::after{content:'';position:absolute;top:0;right:50%;width:50%;border-top:1px solid var(--line);height:25px}
.tree li::after{right:auto;left:50%;border-left:1px solid var(--line)}
.tree li:only-child::after,.tree li:only-child::before{display:none}
.tree li:only-child{padding-top:0}
.tree li:first-child::before,.tree li:last-child::after{border:none}
.tree ul ul::before{content:'';position:absolute;top:0;left:50%;border-left:1px solid var(--line);height:25px}

/* Cards padronizados */
.node{
  display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:center;
  background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);
  width:220px;height:120px;padding:12px 16px;
  transition:transform .15s ease, box-shadow .15s ease;cursor:pointer;position:relative;overflow:hidden;
}
.node:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(10,30,60,0.15);}
.node.leader::before{content:'';position:absolute;top:0;left:0;width:100%;height:6px;background:var(--leader-bar);}
.node.compact{width:150px;height:90px;padding:8px 10px;border-left:4px solid var(--accent);}
.role,.name,.meta{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;}
.role{font-weight:600;color:#0b62d6;font-size:14px}
.name{font-size:14px;color:#0b1724}
.name.clickable{color:#084bb0;font-weight:600;text-decoration:underline;cursor:pointer}
.meta{font-size:12px;color:var(--muted)}
.icon-toggle{position:absolute;right:8px;top:8px;font-size:14px;color:var(--muted);}
.cargo-node{background:#f1f5f9;border:1px dashed var(--accent);}
.collapsed > ul{display:none}

/* Controles de zoom */
.zoom-controls{position:absolute;right:20px;bottom:20px;display:flex;flex-direction:column;gap:6px;z-index:5}
.zoom-controls button{width:36px;height:36px;border-radius:50%;font-size:18px;font-weight:bold}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="title">
      <h1>Organograma</h1>
      <p class="subtitle">Pan & Zoom, agrupado por cargos — clique no nome do líder para focar</p>
    </div>
    <div class="controls">
      <input type="search" id="search" placeholder="Buscar cargo ou nome" />
      <button id="expandAll">Expandir</button>
      <button id="collapseAll">Recolher</button>
      <button id="toggleCompact">Compacto</button>
      <button id="printBtn">Imprimir</button>
      <button id="downloadPNG" class="primary">PNG</button>
      <button id="backBtn" style="display:none">← Voltar</button>
    </div>
  </header>

  <main class="org-wrap" id="orgWrap">
    <!-- wrapper que recebe transform do Panzoom -->
    <div id="panzoom">
      <div class="tree" id="treeContainer"></div>
    </div>

    <div class="zoom-controls">
      <button id="zoomIn">+</button>
      <button id="zoomOut">-</button>
      <button id="resetZoom">⟳</button>
    </div>
  </main>
</div>

<script>
/* ---------- Util ---------- */
const slug = s => (s||"").toString().trim().toLowerCase()
  .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
  .replace(/[\s\/\\]+/g,'-').replace(/[^\w\-]+/g,'').replace(/\-+/g,'-');

async function loadExcel() {
  const res = await fetch("dados.xlsx");
  const buf = await res.arrayBuffer();
  const wb = XLSX.read(buf, {type:"array"});
  const sheet = wb.Sheets[wb.SheetNames[0]];
  return XLSX.utils.sheet_to_json(sheet);
}

/* ---------- Árvore com agrupamento por cargos ---------- */
function buildOrgTree(data) {
  let nodes = {};
  function ensureNode(id, name, role="", desc="", isCargo=false){
    if(!id) return null;
    if(!nodes[id]) nodes[id]={id,name,role,desc,children:[],isCargo};
    return nodes[id];
  }

  data.forEach(r=>{
    const f = r.NomeFuncionario?.trim();
    const cargo = r.DescricaoCargo?.trim();
    const l = r.NomeLider?.trim();
    if(!f) return;

    const fNode = ensureNode(`func_${slug(f)}`, f, "", cargo, false);
    const lNode = l ? ensureNode(`lider_${slug(l)}`, l, "", "", false) : null;

    if(lNode && cargo){
      const cargoId = `cargo_${slug(l)}_${slug(cargo)}`;
      const cargoNode = ensureNode(cargoId, cargo, "Cargo", "", true);
      if(!lNode.children.some(n=>n.id===cargoNode.id)) lNode.children.push(cargoNode);
      if(!cargoNode.children.some(n=>n.id===fNode.id)) cargoNode.children.push(fNode);
    } else if(lNode){
      if(!lNode.children.some(n=>n.id===fNode.id)) lNode.children.push(fNode);
    }
  });

  const lideres = Array.from(new Set(data.map(r=>r.NomeLider?.trim()).filter(Boolean)));
  const roots = lideres.map(l=>nodes[`lider_${slug(l)}`]).filter(Boolean);

  const semLider = data
    .filter(r=>!r.NomeLider || r.NomeLider.trim()==="")
    .map(r=>nodes[`func_${slug(r.NomeFuncionario?.trim())}`])
    .filter(Boolean);

  if(semLider.length>0) roots.push({id:"sem_lider",name:"Sem Líder",role:"",children:semLider,isCargo:false});

  return {id:"root",name:"Organograma",role:"",children:roots,isCargo:false};
}

function countDescendants(node){
  if(!node.children || node.children.length===0) return 0;
  let total = node.children.length;
  node.children.forEach(c=>{ total += countDescendants(c); });
  return total;
}

/* ---------- Render ---------- */
function createNodeElement(node){
  const li=document.createElement('li');
  li.setAttribute('data-id',node.id);

  const numLiderados = node.children ? node.children.length : 0;
  const totalDesc = countDescendants(node);

  const card=document.createElement('div');
  card.className='node';
  if(node.isCargo) card.classList.add('cargo-node');
  if(numLiderados>0 && !node.isCargo) card.classList.add('leader');

  if(node.isCargo){
    card.innerHTML = `
      <div class="role">Cargo</div>
      <div class="name">${node.name||""}</div>
      <div class="meta">${numLiderados} pessoa(s)</div>
    `;
  } else {
    card.innerHTML = `
      <span class="icon-toggle">${numLiderados>0?"▾":""}</span>
      <div class="role">${node.role||""}</div>
      <div class="name ${numLiderados>0?"clickable":""}">${node.name||""}</div>
      ${node.desc?`<div class="meta">${node.desc}</div>`:""}
      ${numLiderados>0?`<div class="meta">Diretos: ${numLiderados}, Total: ${totalDesc}</div>`:""}
    `;
  }

  li.appendChild(card);

  if(node.children && node.children.length){
    const ul=document.createElement('ul');
    node.children.forEach(c=>{
      const childLi = createNodeElement(c);
      childLi.classList.add('collapsed'); // começa recolhido
      ul.appendChild(childLi);
    });
    li.appendChild(ul);
    li.classList.add('collapsed');
  }

  // Clique no nome do líder → foca subárvore
  const nameEl = card.querySelector(".name.clickable");
  if(nameEl){
    nameEl.addEventListener("click", (e)=>{
      e.stopPropagation();
      renderTree({children:[node]}, document.getElementById('treeContainer'));
      showBackButton();
    });
  }

  // Clique no card (fora do nome) → expandir/recolher
  card.addEventListener('click',()=>li.classList.toggle('collapsed'));

  return li;
}

function renderTree(root,target){
  target.innerHTML="";
  root.children.forEach(r=>{
    const ul=document.createElement('ul');
    ul.appendChild(createNodeElement(r));
    target.appendChild(ul);
  });
  // após render, ajustar o pan/zoom para caber na tela
  requestAnimationFrame(autoFit);
}

/* ---------- Controles globais ---------- */
function collapseAll(){document.querySelectorAll('.tree li').forEach(li=>li.classList.add('collapsed'))}
function expandAll(){document.querySelectorAll('.tree li').forEach(li=>li.classList.remove('collapsed'))}
let compact=false;
function toggleCompact(){compact=!compact;document.querySelectorAll('.node').forEach(n=>n.classList.toggle('compact',compact))}
async function downloadPNG(){
  const el=document.getElementById('panzoom');
  const canvas=await html2canvas(el,{scale:2,backgroundColor:null});
  const a=document.createElement('a'); a.href=canvas.toDataURL('image/png'); a.download='organograma.png'; a.click();
}
function showBackButton(){document.getElementById("backBtn").style.display="inline-block";}

/* ---------- Busca ---------- */
function findSubtreeByQuery(node, query){
  const q = query.toLowerCase();
  if((node.name && node.name.toLowerCase().includes(q)) ||
     (node.role && node.role.toLowerCase().includes(q))) return node;
  if(node.children){
    for(const c of node.children){
      const f = findSubtreeByQuery(c, query);
      if(f) return f;
    }
  }
  return null;
}
function renderFilteredTree(query){
  const container=document.getElementById('treeContainer');
  if(!query){ renderTree(orgData,container); return; }
  const subtree=findSubtreeByQuery(orgData,query);
  if(subtree) { renderTree({children:[subtree]},container); showBackButton(); }
  else { alert("Não encontrado: "+query); renderTree(orgData,container); }
}

/* ---------- Pan/Zoom ---------- */
let orgData, panzoomInstance=null, manualPan=null;

function initPanzoom(){
  const panEl = document.getElementById('panzoom');
  const wrap = document.getElementById('orgWrap');

  // Se já existe, reseta
  if(panzoomInstance && panzoomInstance.reset) panzoomInstance.reset();

  if (window.Panzoom) {
    panzoomInstance = Panzoom(panEl, {
      maxScale: 2.5, minScale: 0.3, contain: 'outside'
    });
    // Wheel no próprio elemento transformado (evita inconsistências)
    panEl.addEventListener('wheel', panzoomInstance.zoomWithWheel, { passive: false });
    // Botões
    document.getElementById("zoomIn").onclick=()=>panzoomInstance.zoomIn();
    document.getElementById("zoomOut").onclick=()=>panzoomInstance.zoomOut();
    document.getElementById("resetZoom").onclick=()=>panzoomInstance.reset();
  } else {
    // Fallback manual (sem lib)
    manualPan = (function(){
      let scale=1, min=0.3, max=2.5, x=0, y=0, dragging=false, sx=0, sy=0, ox=0, oy=0;
      const apply=()=>{ panEl.style.transform=`translate(${x}px, ${y}px) scale(${scale})`; };
      wrap.addEventListener('wheel',(e)=>{ e.preventDefault();
        const delta = -e.deltaY; const factor = delta>0 ? 1.1 : 0.9;
        const newScale = Math.min(max, Math.max(min, scale*factor));
        // zoom em torno do cursor
        const rect = panEl.getBoundingClientRect();
        const cx = e.clientX - rect.left; const cy = e.clientY - rect.top;
        x = e.clientX - (cx * newScale/scale) - rect.left + x;
        y = e.clientY - (cy * newScale/scale) - rect.top + y;
        scale = newScale; apply();
      }, {passive:false});
      wrap.addEventListener('mousedown',(e)=>{ if(e.button!==0) return; if(e.target.closest('.node')) return;
        dragging=true; sx=e.clientX; sy=e.clientY; ox=x; oy=y; 
      });
      window.addEventListener('mousemove',(e)=>{ if(!dragging) return; x=ox+(e.clientX-sx); y=oy+(e.clientY-sy); apply(); });
      window.addEventListener('mouseup',()=>dragging=false);
      document.getElementById("zoomIn").onclick=()=>{ scale=Math.min(max,scale*1.1); apply(); };
      document.getElementById("zoomOut").onclick=()=>{ scale=Math.max(min,scale/1.1); apply(); };
      document.getElementById("resetZoom").onclick=()=>{ x=0;y=0;scale=1;apply(); };
      return {apply, reset:()=>{x=0;y=0;scale=1;apply();}};
    })();
  }
  // Ajuste inicial
  requestAnimationFrame(autoFit);
}

function autoFit(){
  const panEl = document.getElementById('panzoom');
  const tree = document.getElementById('treeContainer');
  const wrap = document.getElementById('orgWrap');

  const contentW = tree.scrollWidth || tree.offsetWidth || 1;
  const contentH = tree.scrollHeight || tree.offsetHeight || 1;
  const vw = wrap.clientWidth, vh = wrap.clientHeight;

  const margin = 60;
  const scaleX = (vw - margin)/contentW;
  const scaleY = (vh - margin)/contentH;
  let fit = Math.min(scaleX, scaleY);
  fit = Math.max(0.3, Math.min(1, fit)); // limites razoáveis para abrir legível

  const offsetX = (vw - contentW*fit)/2;
  const offsetY = (vh - contentH*fit)/2;

  if (panzoomInstance){
    panzoomInstance.setTransform({ x: offsetX, y: offsetY, scale: fit });
  } else if (manualPan){
    // Fallback
    panEl.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${fit})`;
  }
}

/* ---------- Boot ---------- */
document.addEventListener('DOMContentLoaded',async ()=>{
  const data = await loadExcel();
  orgData = buildOrgTree(data);
  renderTree(orgData, document.getElementById('treeContainer'));

  document.getElementById('expandAll').onclick=expandAll;
  document.getElementById('collapseAll').onclick=collapseAll;
  document.getElementById('toggleCompact').onclick=toggleCompact;
  document.getElementById('printBtn').onclick=()=>window.print();
  document.getElementById('downloadPNG').onclick=downloadPNG;
  document.getElementById('search').addEventListener('input',e=>renderFilteredTree(e.target.value.trim()));
  document.getElementById("backBtn").onclick=()=>{
    renderTree(orgData, document.getElementById('treeContainer'));
    document.getElementById("backBtn").style.display="none";
  };

  initPanzoom();
});
</script>
</body>
</html>
