<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Organograma Interativo</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root{
  --bg:#f6f8fb;
  --card:#ffffff;
  --leader-bg:#e0f0ff;
  --accent:#0b62d6;
  --muted:#6b7280;
  --line:#cbd5e1;
  --shadow:0 6px 18px rgba(10,30,60,0.08);
  --radius:8px;
  --font-sans:"Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
html,body{height:100%;margin:0;font-family:var(--font-sans);background:var(--bg);color:#0b1724}
.container{max-width:1200px;margin:28px auto;padding:18px;}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px}
.title{display:flex;gap:12px;align-items:baseline}
h1{font-size:20px;margin:0}
.subtitle{color:var(--muted);font-size:13px;margin:0}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.controls button, .controls input[type="search"]{
  background:var(--card);border:1px solid var(--line);padding:8px 10px;border-radius:8px;box-shadow:var(--shadow);
  font-size:13px;color:#0b1724;
}
.controls button:hover{transform:translateY(-1px);cursor:pointer}
.controls .primary{background:linear-gradient(180deg,var(--accent),#084bb0);color:white;border:none}
.org-wrap{overflow:auto;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.6), transparent);border-radius:12px;border:1px solid var(--line)}
.tree{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;padding:30px 10px;}
.tree ul{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;padding-top:20px;position:relative;}
.tree li{list-style:none;text-align:center;position:relative;display:flex;flex-direction:column;align-items:center;padding:10px 5px 0 5px;vertical-align:top;}
.tree li::before, .tree li::after{
  content:'';position:absolute;top:0;right:50%;width:50%;border-top:1px solid var(--line);height:20px
}
.tree li::after{right:auto;left:50%;border-left:1px solid var(--line)}
.tree li:only-child::after,.tree li:only-child::before{display:none}
.tree li:only-child{padding-top:0}
.tree li:first-child::before,.tree li:last-child::after{border:none}
.tree ul ul::before{content:'';position:absolute;top:0;left:50%;border-left:1px solid var(--line);height:20px}
.node{
  display:flex;flex-direction:column;gap:4px;align-items:center;background:var(--card);padding:12px 16px;border-radius:8px;box-shadow:var(--shadow);min-width:180px;
  transition:transform .12s ease;cursor:pointer;position:relative;
}
.node.compact{min-width:140px;padding:8px 12px}
.node:hover{transform:translateY(-6px)}
.node.leader{background: var(--leader-bg);}
.role{font-weight:600;color:var(--accent);font-size:14px}
.name{font-size:13px;color:#0b1724}
.meta{font-size:12px;color:var(--muted)}
.collapsed > ul{display:none}
.collapsed > .node::after{content:'▸';position:absolute;right:8px;top:8px;color:var(--muted);font-size:16px}
.node::after{content:'▾';position:absolute;right:8px;top:8px;color:var(--muted);font-size:16px}
@media (max-width:520px){.title h1{font-size:16px}}
@media print{header, .controls, footer {display:none}}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="title">
      <div>
        <h1>Organograma Organizacional</h1>
        <p class="subtitle">Filtre separadamente por Cargo ou Líder</p>
      </div>
    </div>
    <div class="controls">
      <input type="search" id="searchCargo" placeholder="Filtrar por Cargo" />
      <input type="search" id="searchLider" placeholder="Filtrar por Líder" />
      <button id="expandAll">Expandir tudo</button>
      <button id="collapseAll">Fechar tudo</button>
      <button id="toggleCompact">Modo compacto</button>
      <button id="printBtn">Imprimir</button>
      <button id="downloadPNG" class="primary">Baixar PNG</button>
    </div>
  </header>
  <main>
    <div class="org-wrap" id="orgWrap">
      <div class="tree" id="treeContainer"></div>
    </div>
  </main>
</div>

<script>
let orgData=[];
let navigationStack = [];

async function init(){
  const data = await loadExcel();
  orgData = buildOrgTree(data);
  renderTree(orgData, document.getElementById('treeContainer'));

  document.getElementById('expandAll').onclick = expandAll;
  document.getElementById('collapseAll').onclick = collapseAll;
  document.getElementById('toggleCompact').onclick = toggleCompact;
  document.getElementById('printBtn').onclick = ()=>window.print();
  document.getElementById('downloadPNG').onclick = downloadPNG;

  document.getElementById('searchCargo').addEventListener('input', e=>{
    const val = e.target.value.trim();
    if(!val){ renderTree(orgData,document.getElementById('treeContainer')); removeResetBtn(); return; }
    const filtered = filterTreeByCargo(orgData, val);
    if(filtered) renderTree(filtered, document.getElementById('treeContainer'));
  });

  document.getElementById('searchLider').addEventListener('input', e=>{
    const val = e.target.value.trim();
    if(!val){ renderTree(orgData,document.getElementById('treeContainer')); removeResetBtn(); return; }
    const filtered = filterTreeByLider(orgData, val);
    if(filtered) renderTree(filtered, document.getElementById('treeContainer'));
  });
}

async function loadExcel() {
  const res = await fetch("dados.xlsx");
  const buf = await res.arrayBuffer();
  const wb = XLSX.read(buf, {type:"array"});
  const sheet = wb.Sheets[wb.SheetNames[0]];
  return XLSX.utils.sheet_to_json(sheet);
}

function buildOrgTree(data) {
  let nodes = {};
  function ensureNode(name, role, desc){
    if(!name) return null;
    if(!nodes[name]) nodes[name]={id:name,name,role:role||"",desc:desc||"",children:[]};
    else{ if(role) nodes[name].role=role; if(desc) nodes[name].desc=desc; }
    return nodes[name];
  }

  data.forEach(r=>{
    const f=r.NomeFuncionario?.trim();
    const d=r.DescricaoCargo?.trim();
    const l=r.NomeLider?.trim();
    const fNode = ensureNode(f,"",d);
    const lNode = ensureNode(l);
    if(fNode && lNode && !lNode.children.includes(fNode)) lNode.children.push(fNode);
  });

  const lideres = new Set(data.map(r=>r.NomeLider?.trim()).filter(Boolean));
  let roots = Array.from(lideres).map(l=>nodes[l]).filter(Boolean);

  let semLider = data.filter(r=>!r.NomeLider || r.NomeLider.trim()==="").map(r=>nodes[r.NomeFuncionario?.trim()]).filter(Boolean);
  if(semLider.length>0) roots.push({id:"sem_lider",name:"Sem Líder",role:"",children:semLider});

  return {id:"root",name:"Organograma",role:"",children:roots};
}

function countDescendants(node){
  if(!node.children || node.children.length===0) return 0;
  let total = node.children.length;
  node.children.forEach(c=>{ total += countDescendants(c); });
  return total;
}

function createNodeElement(node){
  const li=document.createElement('li');
  li.setAttribute('data-id',node.id);

  const numLiderados = node.children ? node.children.length : 0;
  const totalDesc = countDescendants(node);

  const card=document.createElement('div');
  card.className='node';
  if(numLiderados>0) card.classList.add('leader');
  card.innerHTML=`
    <div class="role">${node.role||""}</div>
    <div class="name">${node.name||""}</div>
    ${node.desc?`<div class="meta">${node.desc}</div>`:""}
    ${numLiderados>0?`<div class="meta">Diretos: ${numLiderados}, Total: ${totalDesc}</div>`:""}
  `;

  li.appendChild(card);

  if(node.children && node.children.length){
    const ul=document.createElement('ul');
    node.children.forEach(c=>{
      const childLi = createNodeElement(c);
      ul.appendChild(childLi);
    });
    li.appendChild(ul);
    li.classList.add('collapsed');
  }

  card.addEventListener('click', ()=> showSubordinates(node));
  return li;
}

function renderTree(root, target){
  target.innerHTML="";
  const ul=document.createElement('ul');
  ul.appendChild(createNodeElement(root));
  target.appendChild(ul);
}

function showSubordinates(node){
  if(!node.children || node.children.length===0) return;
  const container = document.getElementById('treeContainer');

  // Salva estado atual
  navigationStack.push(container.innerHTML);

  const tempRoot = {
    id: node.id,
    name: node.name,
    role: node.role,
    desc: node.desc,
    children: node.children
  };

  container.innerHTML="";
  const ul=document.createElement('ul');
  ul.appendChild(createNodeElement(tempRoot));
  container.appendChild(ul);

  // Expande toda a árvore do líder
  container.querySelectorAll('li').forEach(li=>li.classList.remove('collapsed'));

  showResetBtn();
}

function showResetBtn(){
  if(document.getElementById('resetBtn')) return;
  const btn=document.createElement('button');
  btn.id='resetBtn';
  btn.textContent='Voltar um nível';
  btn.addEventListener('click', ()=>{
    if(navigationStack.length>0){
      document.getElementById('treeContainer').innerHTML = navigationStack.pop();
    }
    if(navigationStack.length===0) btn.remove();
  });
  document.querySelector('.controls').appendChild(btn);
}

function removeResetBtn(){ const b=document.getElementById('resetBtn'); if(b)b.remove(); }

function collapseAll(){document.querySelectorAll('.tree li').forEach(li=>li.classList.add('collapsed'))}
function expandAll(){document.querySelectorAll('.tree li').forEach(li=>li.classList.remove('collapsed'))}
let compact=false;
function toggleCompact(){compact=!compact;document.querySelectorAll('.node').forEach(n=>n.classList.toggle('compact',compact))}

async function downloadPNG(){
  const el=document.getElementById('orgWrap');
  const canvas = await html2canvas(el,{scale:2});
  const a=document.createElement('a');a.href=canvas.toDataURL();a.download='organograma.png';a.click();
}

function filterTreeByCargo(node, cargo){
  if(node.role && node.role.toLowerCase().includes(cargo.toLowerCase())) return node;
  if(node.children){
    const newChildren = node.children.map(c=>filterTreeByCargo(c,cargo)).filter(Boolean);
    if(newChildren.length) return {...node,children:newChildren};
  }
  return null;
}

function filterTreeByLider(node, lider){
  if(!node) return null;
  const nameMatches = node.name && node.name.toLowerCase().includes(lider.toLowerCase());
  if(node.children){
    const filteredChildren = node.children
      .map(c => filterTreeByLider(c,lider))
      .filter(Boolean);
    if(nameMatches || filteredChildren.length){
      return {...node, children: filteredChildren};
    }
  } else if(nameMatches){
    return {...node, children: []};
  }
  return null;
}


document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
