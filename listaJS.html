<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Organograma Fazenda ‚Üí √Årea ‚Üí L√≠der ‚Üí Liderados</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 20px;
      overflow: hidden;
    }

    h2 {
      text-align: center;
    }

    svg {
      width: 100%;
      height: 85vh;
      border: 1px solid #ccc;
      background: #fff;
    }

    .node rect {
      stroke: #4285f4;
      stroke-width: 1.2px;
      rx: 10;
      ry: 10;
    }

    .node text {
      font-size: 12px;
      text-anchor: middle;
      dominant-baseline: middle;
    }

    .link {
      fill: none;
      stroke: #999;
      stroke-width: 1.2px;
    }

    .painel {
      text-align: center;
      margin-bottom: 10px;
    }

    .painel button,
    .painel select {
      padding: 6px 12px;
      margin: 3px;
    }
  </style>
</head>

<body>
  <h2>üìò Organograma Fazenda ‚Üí √Årea ‚Üí L√≠der ‚Üí Liderados</h2>

  <div class="painel">
    <select id="filtroFazenda">
      <option value="">Todas as Fazendas</option>
    </select>
    <select id="filtroArea">
      <option value="">Todas as √Åreas</option>
    </select>
    <br>
    <button id="expandir">Expandir Todos</button>
    <button id="recolher">Recolher Todos</button>
  </div>

  <svg id="svg"></svg>

  <script>
    const colunaFazenda = "Fazenda";
    const colunaArea = "Setor";
    const colunaLider = "Lider";
    const colunaLiderado = "Liderado";

    let dadosHierarquiaGlobal = null;
    let linhasValidasGlobal = [];

    // ==========================================================
    // 1Ô∏è‚É£ Carrega o Excel automaticamente (sem input)
    // ==========================================================
    async function carregarExcelAutomatico() {
      try {
        const response = await fetch("./wwwroot/Base3.xlsx");
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });
        const planilha = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(planilha);
        processarDadosExcel(json);
      } catch (erro) {
        console.error("Erro ao carregar o Excel:", erro);
        alert("‚ùå N√£o foi poss√≠vel carregar o arquivo dados.xlsx.\nColoque-o na mesma pasta do HTML e abra com Live Server.");
      }
    }

    // ==========================================================
    // 2Ô∏è‚É£ Processa dados do Excel
    // ==========================================================
    function processarDadosExcel(json) {
      const linhasValidas = json.filter(l =>
        l[colunaFazenda] //&& l[colunaArea] && l[colunaLider] && l[colunaLiderado]
      );
      linhasValidasGlobal = linhasValidas;

      // Popula Fazendas
      const filtroFazenda = document.getElementById("filtroFazenda");
      const fazendasUnicas = [...new Set(linhasValidas.map(l => l[colunaFazenda].toString().trim()))];
      filtroFazenda.innerHTML = '<option value="">Todas as Fazendas</option>';
      fazendasUnicas.forEach(fazenda => {
        const opt = document.createElement("option");
        opt.value = fazenda;
        opt.textContent = fazenda;
        filtroFazenda.appendChild(opt);
      });

      // Monta hierarquia
      // const fazendasMap = new Map();
      const diretoriaMap = new Map()
      linhasValidas.forEach(linha => {
        const fazenda = linha[colunaFazenda].toString().trim();
        const diretor = linha["Diretor"]
        const gerente = linha["Gerente"]
        const coordenador = linha["Coordenador"]
        const supervisor = linha["Supervisor"]
        const lideres = linha["Lider"]
        const area = linha[colunaArea].toString().trim();
        const lider = linha[colunaLider].toString().trim();
        const liderado = linha[colunaLiderado].toString().trim();




        if (!diretoriaMap.has(diretor)) diretoriaMap.set(diretor, new Map());
        const fazendasMap = diretoriaMap.get(diretor);

        console.log(diretoriaMap)

        if (!fazendasMap.has(fazenda)) fazendasMap.set(fazenda, new Map());
        const gerentesMap = fazendasMap.get(fazenda);

        console.log(gerentesMap)

        if (!gerentesMap.has(gerente)) gerentesMap.set(gerente, new Map());
        const coordenadorMap = gerentesMap.get(gerente);

        if (!coordenadorMap.has(coordenador)) coordenadorMap.set(coordenador, new Map())
        const supervisorMap = coordenadorMap.get(coordenador)


        if (!supervisorMap.has(supervisor)) supervisorMap.set(supervisor, new Map())
        const liderMap = supervisorMap.get(supervisor)


        if (!liderMap.has(lideres)) liderMap.set(lideres, new Map())
        const lideradosMap = liderMap.get(lideres)



        // if (!areasMap.has(area)) areasMap.set(area, new Map());
        // const lideresMap = areasMap.get(area);

        if (!lideradosMap.has(lider)) lideradosMap.set(lider, []);
        lideradosMap.get(lider).push(liderado);

        // console.log(diretoriaMap)

      });


      function limparHierarquia(node) {
        if (!node.children || node.children.length === 0) return node;

        let novasChildren = [];

        node.children.forEach(child => {
          const filhoLimpo = limparHierarquia(child);

          // Caso o n√≥ seja "NA" ou vazio, seus filhos sobem para o n√≠vel atual
          if (child.name === "NA" || !child.name || child.name.trim() === "") {
            if (filhoLimpo.children && filhoLimpo.children.length > 0) {
              novasChildren.push(...filhoLimpo.children);
            }
          } else {
            novasChildren.push(filhoLimpo);
          }
        });

        node.children = novasChildren;
        return node;
      }




      dadosHierarquiaGlobal = {
        name: "Grupo Michels",
        children: Array.from(diretoriaMap.entries()).map(([diretor, fazendasMap]) => ({
          name: diretor,
          children: Array.from(fazendasMap.entries()).map(([fazenda, gerentesMap]) => ({
            name: fazenda,
            children: Array.from(gerentesMap.entries()).map(([gerente, coordenadorMap]) => ({
              name: gerente,
              children: Array.from(coordenadorMap.entries()).map(([coordenador, supervisorMap]) => ({
                name: coordenador,
                children: Array.from(supervisorMap.entries()).map(([supervisor, liderMap]) => ({
                  name: supervisor,
                  children: Array.from(liderMap.entries()).map(([cargoLider, lideradosMap]) => ({
                    name: cargoLider,
                    children: lideradosMap.get(cargoLider).map(liderado => ({
                      name: liderado
                    }))
                  }))
                }))
              }))
            }))
          }))
        }))
      };

      dadosHierarquiaGlobal = limparHierarquia(dadosHierarquiaGlobal);
      desenharOrganograma(dadosHierarquiaGlobal);
    }

    // ==========================================================
    // 3Ô∏è‚É£ Filtros
    // ==========================================================
    const filtroFazenda = document.getElementById("filtroFazenda");
    const filtroArea = document.getElementById("filtroArea");

    filtroFazenda.addEventListener("change", function () {
      const fazendaSelecionada = this.value;
      filtroArea.innerHTML = '<option value="">Todas as √Åreas</option>';

      let linhasFiltradas = linhasValidasGlobal;
      if (fazendaSelecionada) {
        linhasFiltradas = linhasValidasGlobal.filter(l =>
          l[colunaFazenda].toString().trim() === fazendaSelecionada
        );
      }

      const areasUnicas = [...new Set(linhasFiltradas.map(l => l[colunaArea].toString().trim()))];
      areasUnicas.forEach(area => {
        const opt = document.createElement("option");
        opt.value = area;
        opt.textContent = area;
        filtroArea.appendChild(opt);
      });

      const areaSelecionada = filtroArea.value;
      aplicarFiltros(dadosHierarquiaGlobal, fazendaSelecionada, areaSelecionada);
    });

    filtroArea.addEventListener("change", function () {
      const areaSelecionada = this.value;
      const fazendaSelecionada = filtroFazenda.value;
      aplicarFiltros(dadosHierarquiaGlobal, fazendaSelecionada, areaSelecionada);
    });

    function aplicarFiltros(dadosHierarquia, fazendaSelecionada, areaSelecionada) {
      let fazendasFiltradas = dadosHierarquia.children;
      if (fazendaSelecionada) {
        fazendasFiltradas = fazendasFiltradas.filter(f => f.name === fazendaSelecionada);
      }
      if (areaSelecionada) {
        fazendasFiltradas = fazendasFiltradas.map(fazenda => {
          const areasFiltradas = fazenda.children.filter(a => a.name === areaSelecionada);
          return areasFiltradas.length > 0 ? { ...fazenda, children: areasFiltradas } : null;
        }).filter(Boolean);
      }

      const dadosFiltrados = {
        name: dadosHierarquia.name,
        children: fazendasFiltradas
      };
      desenharOrganograma(dadosFiltrados);
    }

    // ==========================================================
    // 4Ô∏è‚É£ Desenhar Organograma (com pan/zoom e centraliza√ß√£o)
    // ==========================================================
    function desenharOrganograma(dados) {
      const svg = d3.select("#svg");
      svg.selectAll("*").remove();

      const width = window.innerWidth;
      const nodeWidth = 150;
      const nodeHeight = 70;

      const g = svg.append("g").attr("transform", `translate(${width / 2}, 60)`);
      const root = d3.hierarchy(dados);

      let i = 0;
      root.each(d => { d.id = ++i; d.x0 = 0; d.y0 = 0; });

      const zoom = d3.zoom()
        .scaleExtent([0.3, 2])
        .on("zoom", e => g.attr("transform", e.transform));
      svg.call(zoom);

      function layoutVertical(node, nivel = 0, xInicio = 0) {
        const larguraNo = nodeWidth + 120;
        const alturaNo = nodeHeight + 120;
        node.y = nivel * alturaNo;
        node.x = xInicio;

        if (!node.children || node.children.length === 0) return larguraNo;
        let larguraTotal = 0;
        node.children.forEach((filho) => {
          const larguraSub = layoutVertical(filho, nivel + 1, xInicio + larguraTotal);
          larguraTotal += larguraSub;
        });

        const larguraPai = larguraTotal - larguraNo;
        const centroFilhos = xInicio + larguraPai / 2;
        node.x = centroFilhos;

        return larguraTotal;
      }

      layoutVertical(root);
      update(root);
      centralizarOrganograma();

      document.getElementById("expandir").onclick = () => {
        expandCollapseAll(true);
        centralizarOrganograma();
      };
      document.getElementById("recolher").onclick = () => {
        expandCollapseAll(false);
        centralizarOrganograma();
      };

      function centralizarOrganograma() {
        const svgWidth = parseFloat(svg.style("width"));
        const svgHeight = parseFloat(svg.style("height"));
        const transform = d3.zoomTransform(svg.node());
        const scale = transform.k || 1;

        const bbox = g.node().getBBox();
        const x = (svgWidth - bbox.width) / 2 - bbox.x;
        const y = (svgHeight - bbox.height) / 2 - bbox.y;

        svg.transition()
          .duration(800)
          .call(zoom.transform, d3.zoomIdentity.translate(x, y).scale(scale));
      }

      function diagonal(d) {
        const x1 = d.source.x - width / 2;
        const y1 = d.source.y + nodeHeight / 2;
        const x2 = d.target.x - width / 2;
        const y2 = d.target.y - nodeHeight / 2;
        return `M${x1},${y1} L${x1},${(y1 + y2) / 2} L${x2},${(y1 + y2) / 2} L${x2},${y2}`;
      }

      function wrapText(textSelection, text, width) {
        const maxChars = Math.floor(width / 8);
        const words = text.split(/\s+/);
        let lines = [];
        let currentLine = "";
        words.forEach(word => {
          if ((currentLine + " " + word).trim().length <= maxChars) {
            currentLine = (currentLine + " " + word).trim();
          } else {
            lines.push(currentLine);
            currentLine = word;
          }
        });
        if (currentLine) lines.push(currentLine);
        if (lines.length > 3) {
          lines = lines.slice(0, 3);
          lines[2] += "...";
        }
        textSelection.text(null);
        const totalHeight = lines.length * 14;
        const offsetY = -totalHeight / 2 + 6;
        lines.forEach((line, i) => {
          textSelection.append("tspan")
            .attr("x", 0)
            .attr("y", offsetY + i * 14)
            .text(line);
        });
      }

      function update(source) {
        layoutVertical(root);
        const nodes = root.descendants();
        const links = root.links();

        const node = g.selectAll("g.node").data(nodes, d => d.id);
        const nodeEnter = node.enter().append("g")
          .attr("class", "node")
          .attr("transform", d => `translate(${source.x0 - width / 2},${source.y0})`)
          .on("click", (event, d) => {
            if (d.children || d._children) toggleChildren(d);
          });

        nodeEnter.append("rect")
          .attr("x", -nodeWidth / 2)
          .attr("y", -nodeHeight / 2)
          .attr("width", nodeWidth)
          .attr("height", nodeHeight)
          .attr("fill", d => {
            if (d.depth === 0) return "#fff9c4";
            if (d.depth === 1) return "#b2dfdb";
            if (d.depth === 2) return "#bbdefb";
            if (d.depth === 3) return "#c8e6c9";
            return "#e1bee7";
          });

        nodeEnter.append("text")
          .attr("font-size", 12)
          .each(function (d) {
            const t = d3.select(this);
            wrapText(t, d.data.name, nodeWidth);
          });

        nodeEnter.merge(node)
          .transition().duration(500)
          .attr("transform", d => `translate(${d.x - width / 2},${d.y})`);

        node.exit().transition().duration(500)
          .attr("transform", d => `translate(${source.x - width / 2},${source.y})`)
          .remove();

        const link = g.selectAll("path.link").data(links, d => d.target.id);
        link.enter().insert("path", "g")
          .attr("class", "link")
          .attr("d", () => diagonal({ source: source, target: source }))
          .merge(link)
          .transition().duration(500)
          .attr("d", d => diagonal(d));
        link.exit().transition().duration(500)
          .attr("d", () => diagonal({ source: source, target: source }))
          .remove();

        nodes.forEach(d => { d.x0 = d.x; d.y0 = d.y; });
      }

      function expandCollapseAll(expandir) {
        root.descendants().forEach(d => {
          if (expandir && d._children) {
            d.children = d._children; d._children = null;
          } else if (!expandir && d.children) {
            d._children = d.children; d.children = null;
          }
        });
        layoutVertical(root);
        update(root);
      }

      function toggleChildren(d) {
        if (d.children) { d._children = d.children; d.children = null; }
        else if (d._children) { d.children = d._children; d._children = null; }
        update(d);
      }
    }

    // ==========================================================
    // 5Ô∏è‚É£ Inicializa√ß√£o
    // ==========================================================
    window.onload = carregarExcelAutomatico;
  </script>
</body>

</html>